name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Build application
        run: |
          go mod tidy
          go build -o discord-typing-game main.go

      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          cp discord-typing-game deploy-package/
          cp -r static deploy-package/
          cp deploy/app.service deploy-package/
          tar -czf deploy.tar.gz -C deploy-package .

      - name: Deploy to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          source: "deploy.tar.gz"
          target: "/tmp/"

      - name: Execute deployment on server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            set -e
            APP_DIR="/opt/discord-typing-game"
            sudo systemctl stop discord-typing-game || true
            mkdir -p /tmp/deploy
            tar -xzf /tmp/deploy.tar.gz -C /tmp/deploy
            sudo mkdir -p $APP_DIR
            sudo cp /tmp/deploy/discord-typing-game $APP_DIR/
            sudo cp -r /tmp/deploy/static $APP_DIR/
            sudo chown -R ${{ secrets.EC2_USER }}:${{ secrets.EC2_USER }} $APP_DIR
            sudo chmod +x $APP_DIR/discord-typing-game
            sudo cp /tmp/deploy/app.service /etc/systemd/system/discord-typing-game.service
            sudo systemctl daemon-reload
            sudo systemctl start discord-typing-game
            sudo systemctl enable discord-typing-game
            rm -rf /tmp/deploy /tmp/deploy.tar.gz
            